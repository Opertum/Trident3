[gcode_macro BELT_LED_STROBE]
description: Use Shake&Tune's belt excitation with synchronized LED strobe
gcode:
    {% set frequency = params.FREQ|default(110)|float %}
    {% set duration = params.DURATION|default(30)|float %}
    
    RESPOND MSG="Starting belt excitation at {frequency}Hz with LED strobe"
    
    # Start the LED strobe in background
    UPDATE_DELAYED_GCODE ID=_LED_STROBE_LOOP DURATION=0.001
    SET_GCODE_VARIABLE MACRO=_LED_STROBE_HELPER VARIABLE=frequency VALUE={frequency}
    SET_GCODE_VARIABLE MACRO=_LED_STROBE_HELPER VARIABLE=running VALUE=1
    
    # Run Shake&Tune's belt excitation
    EXCITATE_AXIS_AT_FREQ FREQUENCY={frequency} DURATION={duration}
    
    # Stop the LED strobe
    SET_GCODE_VARIABLE MACRO=_LED_STROBE_HELPER VARIABLE=running VALUE=0
    SET_LED LED=Case RED=0 GREEN=0 BLUE=0
    
    RESPOND MSG="Belt excitation complete"

[gcode_macro _LED_STROBE_HELPER]
variable_running: 0
variable_frequency: 110
variable_led_state: 0
gcode:
    # This macro holds variables for the LED strobe

[delayed_gcode _LED_STROBE_LOOP]
gcode:
    {% if printer["gcode_macro _LED_STROBE_HELPER"].running %}
        {% set freq = printer["gcode_macro _LED_STROBE_HELPER"].frequency %}
        {% set state = printer["gcode_macro _LED_STROBE_HELPER"].led_state %}
        {% set period = 1.0 / freq / 2 %}
        
        # Toggle LED state
        {% if state %}
            SET_LED LED=Case RED=0 GREEN=0 BLUE=0
            SET_GCODE_VARIABLE MACRO=_LED_STROBE_HELPER VARIABLE=led_state VALUE=0
        {% else %}
            SET_LED LED=Case RED=1 GREEN=1 BLUE=1
            SET_GCODE_VARIABLE MACRO=_LED_STROBE_HELPER VARIABLE=led_state VALUE=1
        {% endif %}
        
        # Schedule next toggle
        UPDATE_DELAYED_GCODE ID=_LED_STROBE_LOOP DURATION={period}
    {% endif %}