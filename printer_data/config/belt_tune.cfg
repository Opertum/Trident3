[gcode_macro BELT_LED_STROBE]
description: Excite belts at 110Hz and strobe LEDs at the same frequency
variable_running: 0
gcode:
    {% set frequency = params.FREQ|default(110)|float %}
    {% set amplitude = params.AMPLITUDE|default(5)|float %}
    
    # Calculate period in seconds
    {% set period = 1.0 / frequency %}
    {% set half_period = period / 2 %}
    
    # Save current position
    SAVE_GCODE_STATE NAME=belt_strobe_state
    
    # Set to relative positioning
    G91
    
    # Set running flag
    SET_GCODE_VARIABLE MACRO=BELT_LED_STROBE VARIABLE=running VALUE=1
    
    RESPOND MSG="Starting belt excitation at {frequency}Hz - use BELT_LED_STROBE_STOP to stop"
    
    # Perform oscillation with LED strobe - runs until stopped
    {% for i in range(100000) %}
        {% if printer["gcode_macro BELT_LED_STROBE"].running %}
            # Move forward and turn LED on
            SET_LED LED=Case RED=1 GREEN=1 BLUE=1
            G1 X{amplitude} F{amplitude * frequency * 60}
            G4 P{half_period * 1000}
            
            # Move backward and turn LED off
            SET_LED LED=Case RED=0 GREEN=0 BLUE=0
            G1 X-{amplitude} F{amplitude * frequency * 60}
            G4 P{half_period * 1000}
        {% endif %}
    {% endfor %}

[gcode_macro BELT_LED_STROBE_STOP]
description: Stop the belt excitation and LED strobe
gcode:
    SET_GCODE_VARIABLE MACRO=BELT_LED_STROBE VARIABLE=running VALUE=0
    
    # Turn off LEDs
    SET_LED LED=Case RED=0 GREEN=0 BLUE=0
    
    # Restore position and state
    RESTORE_GCODE_STATE NAME=belt_strobe_state
    
    RESPOND MSG="Belt excitation stopped"